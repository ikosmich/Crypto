//
//  APIService.swift
//  Crypto
//
//  Created by Artem Alekseev on 04.03.2023.
//

import Foundation

let jsonTemp = """
{"status":{"elapsed":4,"timestamp":"2023-03-05T10:24:17.811918418Z"},"data":{"id":"1e31218a-e44e-4285-820c-8282ee222035","serial_id":6057,"symbol":"BTC","name":"Bitcoin","slug":"bitcoin","contract_addresses":null,"_internal_temp_agora_id":"9793eae6-f374-46b4-8764-c2d224429791","market_data":{"price_usd":22390.855324949902,"price_btc":1,"price_eth":14.252088990923472,"volume_last_24_hours":8060527159.852944,"real_volume_last_24_hours":5026461963.772512,"volume_last_24_hours_overstatement_multiple":1.603618453287424,"percent_change_usd_last_1_hour":0.09707758173571579,"percent_change_btc_last_1_hour":0,"percent_change_eth_last_1_hour":-0.11139959804209842,"percent_change_usd_last_24_hours":0.19545662722375615,"percent_change_btc_last_24_hours":0.026393666516836375,"percent_change_eth_last_24_hours":0.10688621585242385,"ohlcv_last_1_hour":{"open":22381.103906295742,"high":22381.175456101002,"low":22364.59704989002,"close":22369.13990487517,"volume":4428431.24997832},"ohlcv_last_24_hour":{"open":22353.095237539,"high":22353.929992468657,"low":22343.84867238495,"close":22347.17628789783,"volume":56845893.3735604},"last_trade_at":"2023-03-05T10:24:16Z"},"marketcap":{"rank":1,"marketcap_dominance_percent":40.790696564977,"current_marketcap_usd":431972967466.89795,"y_2050_marketcap_usd":469536242712.739,"y_plus10_marketcap_usd":463545584315.3443,"liquid_marketcap_usd":432233310477.2619,"volume_turnover_last_24_hours_percent":1.1594571440926555,"realized_marketcap_usd":383242771600.77856,"outstanding_marketcap_usd":431236820216.1602},"supply":{"y_2050":20986335.65,"y_plus10":20718577.9,"liquid":19319048.26,"circulating":19307412,"y_2050_issued_percent":92.05536679768106,"annual_inflation_percent":1.7400142360843067,"stock_to_flow":57.470794161453526,"y_plus10_issued_percent":93.2450497000569,"supply_revived_90d":19308288.36119328},"blockchain_stats_24_hours":{"count_of_active_addresses":905589,"transaction_volume":5883890860.7353525,"adjusted_transaction_volume":2089655119.7208831,"adjusted_nvt":206.367460422733,"median_tx_value":55.835713159702,"median_tx_fee":0.6753887863797554,"count_of_tx":306924,"count_of_payments":839858,"new_issuance":21217571.00068676,"average_difficulty":43053844193928.45,"kilobytes_added":null,"count_of_blocks_added":152},"market_data_liquidity":{"clearing_prices_to_sell":null,"marketcap":null,"asset_bid_depth":null,"usd_bid_depth":null,"updated_at":"0001-01-01T00:00:00Z"},"all_time_high":{"price":68753.85761733251,"at":"2021-11-10T14:15:00Z","days_since":479,"percent_down":67.39351561819105,"breakeven_multiple":3.0668746384627004},"cycle_low":{"price":13701.040774823985,"at":"2023-01-07T03:41:44Z","percent_up":63.62418165400059,"days_since":0},"token_sale_stats":{"sale_proceeds_usd":null,"sale_start_date":null,"sale_end_date":null,"roi_since_sale_usd_percent":null,"roi_since_sale_btc_percent":null,"roi_since_sale_eth_percent":null},"mining_stats":{"mining_algo":"SHA-256","network_hash_rate":"354243 PH/s","available_on_nicehash_percent":0.04765826390638727,"1_hour_attack_cost":null,"24_hours_attack_cost":null,"attack_appeal":null,"hash_rate":325313168.29752123,"hash_rate_30d_average":304020369.66293025,"mining_revenue_per_hash_usd":7.70834e-7,"mining_revenue_per_hash_native_units":3.5e-11,"mining_revenue_per_hash_per_second_usd":0.066600025104,"mining_revenue_per_hash_per_second_native_units":0.000002981964,"mining_revenue_from_fees_percent_last_24_hours":2.0691265781,"mining_revenue_native":970.07201795,"mining_revenue_usd":21665865.175403796,"mining_revenue_total":48739507924.80324,"average_difficulty":43053844193928.45},"developer_activity":{"stars":68485,"watchers":3921,"commits_last_3_months":null,"commits_last_1_year":null,"lines_added_last_3_months":null,"lines_added_last_1_year":null,"lines_deleted_last_3_months":null,"lines_deleted_last_1_year":null},"roi_data":{"percent_change_last_1_week":-5.012714550067107,"percent_change_last_1_month":-4.512155388149062,"percent_change_last_3_months":31.885782836859022,"percent_change_last_1_year":-43.21552056476358,"percent_change_btc_last_1_week":0,"percent_change_btc_last_1_month":0,"percent_change_btc_last_3_months":0,"percent_change_btc_last_1_year":0,"percent_change_eth_last_1_week":-0.6049005121227723,"percent_change_eth_last_1_month":1.2719467233962058,"percent_change_eth_last_3_months":5.880427083210557,"percent_change_eth_last_1_year":-3.504728219585877,"percent_change_month_to_date":-5.318597012553082,"percent_change_quarter_to_date":34.70371598943369,"percent_change_year_to_date":34.70371598943369},"roi_by_year":{"2021_usd_percent":57.15628017931246,"2020_usd_percent":303.4684984048765,"2019_usd_percent":85.45005684038458,"2018_usd_percent":-72.43276332059733,"2017_usd_percent":1294.5693898256334,"2016_usd_percent":123.49918824658808,"2015_usd_percent":36.814097085453525,"2014_usd_percent":-57.34471540548051,"2013_usd_percent":5394.306975681845,"2012_usd_percent":156.47080487351116,"2011_usd_percent":1474.0066666666667},"risk_metrics":{"sharpe_ratios":{"last_30_days":-1.1522284136073941,"last_90_days":2.7780904118883956,"last_1_year":-0.7663188015643442,"last_3_years":0.777586892188331},"volatility_stats":{"volatility_last_30_days":0.5154748157450934,"volatility_last_90_days":0.4399836597946679,"volatility_last_1_year":0.6074907618360419,"volatility_last_3_years":0.7385575032137869}},"misc_data":{"private_market_price_usd":null,"vladimir_club_cost":null,"btc_current_normalized_supply_price_usd":null,"btc_y2050_normalized_supply_price_usd":null,"asset_created_at":null,"asset_age_days":null,"categories":["Payments"],"sectors":["Currencies"],"tags":null},"reddit":{"active_user_count":7704,"subscribers":4843670},"on_chain_data":{"addresses_count":44556222,"active_addresses":905589,"active_addresses_received_count":681263,"active_addresses_sent_count":562437,"addresses_balance_greater_0_001_native_units_count":22033651,"addresses_balance_greater_0_01_native_units_count":11588614,"addresses_balance_greater_0_1_native_units_count":4245261,"addresses_balance_greater_1_usd_count":36705082,"addresses_balance_greater_1_native_units_count":983476,"addresses_balance_greater_10_usd_count":25886404,"addresses_balance_greater_10_native_units_count":155500,"addresses_balance_greater_100_usd_count":14994457,"addresses_balance_greater_100_native_units_count":16078,"addresses_balance_greater_100k_usd_count":278209,"addresses_balance_greater_100k_native_units_count":4,"addresses_balance_greater_10k_usd_count":1741408,"addresses_balance_greater_10k_native_units_count":116,"addresses_balance_greater_10m_usd_count":4837,"addresses_balance_greater_1k_usd_count":6246006,"addresses_balance_greater_1k_native_units_count":2007,"addresses_balance_greater_1m_usd_count":66700,"addresses_balance_greater_1m_native_units_count":0,"average_block_gas_limit":null,"block_height":779360,"average_block_interval":561.64238411,"blocks_added_last_24_hours":152,"block_size_bytes_total":325183460,"block_size_bytes_average":2139364.8684210526,"uncle_blocks_count_last_24_hours":null,"uncle_rewards_last_24_hours_usd":null,"uncle_rewards_last_24_hours_native_units":null,"mining_revenue_from_uncle_blocks_percent_last_24_hours":null,"block_weight":603084695,"average_block_weight":3967662.46710526,"total_fees_last_24_hours":20.07201795,"total_fees_last_24_hours_usd":448294.1747170359,"hash_rate":325313168.29752123,"issuance_last_24_hours_native_units":950,"issuance_rate_daily":0.0049201668,"issuance_total_usd":21217571.00068676,"issuance_total_native_units":950,"new_issuance":21217571.00068676,"issuance_rate":1.795860882,"realized_marketcap_usd":383242771600.77856,"adjusted_nvt":206.367460422733,"adjusted_nvt_90d_moving_average":143.31939539543086,"adjusted_rvt":183.400010836223,"adjusted_rvt_90d_moving_average":127.3688139337469,"txn_count_last_24_hours":306924,"txn_contracts_calls_count_last_24_hours":null,"txn_contracts_calls_success_count_last_24_hours":null,"txn_contracts_creation_count_last_24_hours":null,"txn_contracts_destruction_count_last_24_hours":null,"txn_contracts_count_last_24_hours":null,"txn_erc20_count_last_24_hours":null,"txn_erc721_count_last_24_hours":null,"txn_per_second_count":3.552361111111,"txn_token_count_last_24_hours":null,"average_fee_usd":1.4606622562578042,"average_fee_native_units":0.0000654,"median_fee_usd":0.6753887863797554,"median_fee_native_units":0.00003024,"average_txn_gas_used":null,"txn_gas_limit_last_24_hours":null,"average_txn_gas_limit":null,"txn_gas_used_last_24_hours":null,"transfer_count_last_24_hours":839858,"transfer_erc_20_count_last_24_hours":null,"transfer_erc721_count_last_24_hours":null,"txn_volume_last_24_hours_usd":5883890860.7353525,"adjusted_txn_volume_last_24_hours_usd":2089655119.7208831,"adjusted_txn_volume_last_24_hours_native_units":93562.65915974,"txn_volume_last_24_hours_native_units":263446.57065211,"average_transfer_value_usd":7005.816293638427,"average_transfer_value_native_units":0.313679896664,"median_transfer_value_usd":55.835713159702,"median_transfer_value_native_units":0.0025,"average_utxo_age":1274.714212,"value_weighted_average_utxo_age":1403.57882235,"median_utxo_age":990,"utxo_count_last_24_hours":84971315,"utxo_in_loss_count":26967896,"utxo_in_profit_count":58003419},"exchange_flows":{"flow_in_exchange_native_units":11075.83824345,"flow_in_exchange_usd":247370930.86581275,"flow_in_exchange_native_units_inclusive":12956.75465888,"flow_in_exchange_usd_inclusive":289379854.6455425,"flow_out_exchange_native_units":12876.50943749,"flow_out_exchange_usd":287587634.97995496,"flow_out_exchange_native_units_inclusive":14757.42585292,"flow_out_exchange_usd_inclusive":329596558.7596847,"flow_in_binance_usd":175814701.3233414,"flow_in_binance_native_units":7871.96452656,"flow_in_bitfinex_usd":4822952.707370148,"flow_in_bitfinex_native_units":215.94390196,"flow_in_bitmex_usd":3688641.280917553,"flow_in_bitmex_native_units":165.15600286,"flow_in_bitstamp_usd":8786385.781080106,"flow_in_bitstamp_native_units":393.40349052,"flow_in_bittrex_usd":4827411.036076096,"flow_in_bittrex_native_units":216.14352011,"flow_in_gemini_usd":11461490.468519313,"flow_in_gemini_native_units":513.17919213,"flow_in_huobi_usd":5753379.265174278,"flow_in_huobi_native_units":257.60301694,"flow_in_kraken_usd":39208128.495190226,"flow_in_kraken_native_units":1755.51301651,"flow_in_poloniex_usd":3334842.1771236802,"flow_in_poloniex_native_units":149.31492715,"flow_net_binance_usd":37831904.24664071,"flow_net_binance_native_units":1693.89366168,"flow_net_bitfinex_usd":2724792.859545455,"flow_net_bitfinex_native_units":122.00045031,"flow_net_bitmex_usd":2153944.778179934,"flow_net_bitmex_native_units":96.44117789,"flow_net_bitstamp_usd":-21169255.130820695,"flow_net_bitstamp_native_units":-947.83669505,"flow_net_bittrex_usd":-9981083.96750351,"flow_net_bittrex_native_units":-446.89515915,"flow_net_gemini_usd":-3788022.2760216123,"flow_net_gemini_native_units":-169.6057085,"flow_net_huobi_usd":-2038914.8281304024,"flow_net_huobi_native_units":-91.29080264,"flow_net_kraken_usd":-7678700.033662249,"flow_net_kraken_native_units":-343.80773519,"flow_net_poloniex_usd":935473.319436897,"flow_net_poloniex_native_units":41.88507975,"flow_out_binance_usd":138208978.05260915,"flow_out_binance_native_units":6188.19793961,"flow_out_bitfinex_usd":2098159.8478246937,"flow_out_bitfinex_native_units":93.94345165,"flow_out_bitmex_usd":1534696.5027376194,"flow_out_bitmex_native_units":68.71482497,"flow_out_bitstamp_usd":43957114.959065646,"flow_out_bitstamp_native_units":1968.14513828,"flow_out_bittrex_usd":14895625.991631277,"flow_out_bittrex_native_units":666.9399005,"flow_out_gemini_usd":15312699.771167863,"flow_out_gemini_native_units":685.61404989,"flow_out_huobi_usd":7863038.058686335,"flow_out_huobi_native_units":352.06132481,"flow_out_kraken_usd":73301310.34475243,"flow_out_kraken_native_units":3282.00833287,"flow_out_poloniex_usd":2399368.857686783,"flow_out_poloniex_native_units":107.4298474,"supply_exchange_native_units":1418885.56027471,"supply_exchange_usd":31689794859.976707,"supply_binance_usd":13329856338.065456,"supply_binance_native_units":596833.79971969,"supply_bitfinex_usd":5681247441.094045,"supply_bitfinex_native_units":254373.37143185,"supply_bitmex_usd":1444849482.8649924,"supply_bitmex_native_units":64691.99554828,"supply_bitstamp_usd":510017555.31587124,"supply_bitstamp_native_units":22835.63361397,"supply_bittrex_usd":647329210.1163133,"supply_bittrex_native_units":28983.65461299,"supply_gemini_usd":2858481819.6500072,"supply_gemini_native_units":127986.26801247,"supply_huobi_usd":261260781.46092626,"supply_huobi_native_units":11697.74534417,"supply_kraken_usd":1515500262.382491,"supply_kraken_native_units":67855.32845474,"supply_poloniex_usd":600794465.8923033,"supply_poloniex_native_units":26900.09815823},"miner_flows":{"supply_1hop_miners_usd":57543406346.279,"supply_1hop_miners_native_units":2576460.61498725,"supply_miners_usd":40225253935.64057,"supply_miners_native_units":1801054.00555142},"supply_activity":{"supply_active_10y":16610700.53933627,"supply_active_180d":4354823.38718613,"supply_active_1d":212342.78795841,"supply_active_1y":6224528.34128462,"supply_active_1y_percent":32.2375977862,"supply_active_2y":9404313.03558976,"supply_active_30d":1222136.13882336,"supply_active_3y":11695274.11772193,"supply_active_4y":12607988.41778377,"supply_active_5y":13802738.40279597,"supply_active_7d":557992.58158375,"supply_active_90d":2660150.12695437,"supply_active_ever":17536017.37467819,"outstanding":3438.76003894,"supply_revived_1y":2661.45895618,"supply_revived_2y":2063.65606187,"supply_revived_30d":6835.45444566,"supply_revived_3y":1858.7273861,"supply_revived_4y":221.49296099,"supply_revived_5y":198.31960879,"supply_revived_7d":12388.2519485,"supply_revived_90d":4538.3847185},"supply_distribution":{"supply_in_addresses_balance_greater_0_001_native_units":19301069.97279869,"supply_in_addresses_balance_greater_0_01_native_units":19262010.26335046,"supply_in_addresses_balance_greater_0_1_native_units":19014650.45017563,"supply_in_addresses_balance_greater_1_usd":19305538.46119836,"supply_in_addresses_balance_greater_10_usd":19303740.05949596,"supply_in_addresses_balance_greater_100_usd":19285330.66126513,"supply_in_addresses_balance_greater_100k_usd":16721889.79426471,"supply_in_addresses_balance_greater_100k_native_units":663305.78975487,"supply_in_addresses_balance_greater_100_native_units":11506846.75121453,"supply_in_addresses_balance_greater_10k_usd":18503540.89620318,"supply_in_addresses_balance_greater_10k_native_units":3043350.34215497,"supply_in_addresses_balance_greater_10m_usd":9481002.67665756,"supply_in_addresses_balance_greater_10_native_units":15931067.29993041,"supply_in_addresses_balance_greater_1k_usd":19149392.42456978,"supply_in_addresses_balance_greater_1k_native_units":7590403.69400611,"supply_in_addresses_balance_greater_1m_usd":14273715.57464919,"supply_in_addresses_balance_greater_1m_native_units":0,"supply_in_addresses_balance_greater_1_native_units":18000737.21340547,"supply_in_contracts_usd":null,"supply_in_contracts_native_units":null,"supply_shielded":null,"supply_in_top_100_addresses":2883350.30777134,"supply_in_top_10_percent_addresses":19035184.07107697,"supply_in_top_1_percent_addresses":17254749.08428387,"supply_in_utxo_in_loss":7025214.56538896,"supply_in_utxo_in_profit":12283073.79580432},"alert_messages":null}}
""".data(using: .utf8) ?? Data()



class APIServise {
    static let shared = APIServise()
    
    
    private let coinsTypes = ["btc", "eth", "tron", "luna", "polkadot", "dogecoin", "tether", "stellar", "cardano", "xrp"]
    //private let url = "https://data.messari.io/api/v1/assets/btc/metrics"
    
    let dispachGroup = DispatchGroup()
    
    public func getCoinsInfo(_ completionHandler: @escaping (Coin) -> Void) {
        for index in 0..<coinsTypes.count {
            let url = "https://data.messari.io/api/v1/assets/\(coinsTypes[index])/metrics"
            print(url)
            guard let url = URL(string: url) else { return }
            dispachGroup.enter()
            let request = URLRequest(url: url)
            let urlTask = URLSession.shared.dataTask(with: request) { data, _, error in
                guard let data = data else { return }
                guard error == nil else {
                    print("Task error\n\(String(describing: error))")
                    return
                }
                do {
                    let coins = try JSONDecoder().decode(Coin.self, from: data)
                    completionHandler(coins)
                } catch let error {
                    print("Error parsing data - \(error)")
                }
            }
            urlTask.resume()
            dispachGroup.leave()
        }
        dispachGroup.notify(queue: .main) {
            print("ALL DATA WAS LOADED")
        }
      
    }
}




